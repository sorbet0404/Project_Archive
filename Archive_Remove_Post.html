<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Remove Post</title>
    <!-- CSS 파일 연결 -->
    <link rel="stylesheet" href="CSS/Archive_styles.css">
</head>
<body class="write-post">
    <div class="header">
        <!-- 환영 메시지를 표시할 영역 -->
        <div class="welcome" id="welcomeMessage"></div>
        <!-- 돌아가기 버튼 -->
        <button class="write-button" onclick="goToNoticeBoard()">돌아가기</button>
        <!-- 로그아웃 버튼 -->
        <button class="logout-button" onclick="logout()">로그아웃</button>
    </div>
    <div class="center-container">
        <div class="write-container">
            <h2>삭제하기</h2>
            <!-- 게시물 삭제 폼 -->
            <form id="removePostForm" onsubmit="return removePost(event)">
                <div class="form-row">
                    <div class="form-group">
                        <label for="grade">학년</label>
                        <select id="grade" name="grade" required onchange="updateSubjects()">
                            <option value="">학년 선택</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="subject">과목</label>
                        <select id="subject" name="subject" required onchange="updateRows()">
                            <option value="">과목 선택</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="student_id">평가 선택</label>
                        <select id="student_id" name="student_id" required>
                            <option value="">평가 선택</option>
                        </select>
                    </div>
                </div>
                <button type="submit">삭제하기</button>
            </form>
        </div>
    </div>

    <script>
        // 학년별 과목 데이터를 정의함
        const subjects = {
            "2학년": ["선형대수학", "디지털 논리 회로 및 실험"],
            "3학년": ["소프트웨어 분석", "데이터 통신"],
            "4학년": ["인공지능", "빅데이터 분석 및 시각화"]
        };

        // 로그인한 사용자의 이름을 세션 또는 로컬 스토리지에서 가져옴
        const userName = sessionStorage.getItem('userName') || '사용자';
        document.getElementById('welcomeMessage').innerText = `${userName}님 환영합니다!`;

        const gradeSelect = document.getElementById('grade');
        const userStudentId = sessionStorage.getItem('userStudentId');
        if (userStudentId) {
            const year = parseInt("20" + userStudentId.substring(0, 2), 10);
            const currentYear = new Date().getFullYear();
            const yearsInSchool = currentYear - year;

            for (let i = 2; i <= Math.min(4, yearsInSchool + 1); i++) {
                const option = document.createElement('option');
                option.value = `${i}학년`;
                option.text = `${i}학년`;
                gradeSelect.appendChild(option);
            }
        }

        // 선택된 학년에 따라 과목 선택 업데이트
        function updateSubjects() {
            const selectedGrade = document.getElementById('grade').value;
            const subjectSelect = document.getElementById('subject');
            subjectSelect.innerHTML = '<option value="">과목 선택</option>';
            if (selectedGrade && subjects[selectedGrade]) {
                subjects[selectedGrade].forEach(subject => {
                    const option = document.createElement('option');
                    option.value = subject;
                    option.text = subject;
                    subjectSelect.appendChild(option);
                });
            }
        }

        // 선택된 과목에 따라 평가 선택 업데이트
        function updateRows() {
            const selectedSubject = document.getElementById('subject').value;
            console.log("Selected subject:", selectedSubject); // 디버깅 로그 추가
            const rowSelect = document.getElementById('student_id');
            rowSelect.innerHTML = '<option value="">평가 선택</option>';
            if (selectedSubject) {
                fetch(`/Archive_Project/Archive_GetRows_Servlet?subject=${encodeURIComponent(selectedSubject)}`)
                    .then(response => {
                        console.log("서버 응답 상태:", response.status, response.statusText);
                        if (!response.ok) {
                            throw new Error('Network response was not ok ' + response.statusText);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log("받은 데이터:", data);
                        if (data.rows) {
                            data.rows.forEach(row => {
                                const option = document.createElement('option');
                                option.value = row.studentid; // student_id -> studentid로 변경
                                option.text = `${row.evaluation}`;
                                rowSelect.appendChild(option);
                            });
                        } else {
                            console.log("데이터가 없음");
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching rows:', error);
                        alert('데이터를 가져오는 중 오류가 발생했습니다.');
                    });
            }
        }

        // 게시물 삭제 함수
        function removePost(event) {
            event.preventDefault(); // 폼 제출 기본 동작 방지

            const subject = document.getElementById('subject').value;
            const studentId = document.getElementById('student_id').value;

            fetch('/Archive_Project/Archive_DeleteRow_Servlet', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: `subject=${encodeURIComponent(subject)}&student_id=${encodeURIComponent(studentId)}` // studentId 그대로 사용
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('삭제 성공');
                    resetForm(); // 폼 초기화
                } else {
                    alert(`삭제 실패: ${data.message}`);
                }
            })
            .catch(error => {
                console.error('Error deleting row:', error);
                alert('행 삭제 중 오류가 발생했습니다.');
            });
        }

        // 폼 초기화 함수
        function resetForm() {
            document.getElementById('grade').innerHTML = '<option value="">학년 선택</option>';
            document.getElementById('subject').innerHTML = '<option value="">과목 선택</option>';
            document.getElementById('student_id').innerHTML = '<option value="">평가 선택</option>';
        }

        // 로그아웃 함수
        function logout() {
            alert('로그아웃 되었습니다.');
            sessionStorage.clear(); // 모든 세션 스토리지 항목 제거
            window.location.href = 'Archive_Login.html'; // 로그인 페이지로 리다이렉트
        }

        //게시판으로 이동하는 함수
        function goToNoticeBoard() {
            window.location.href = 'Archive_Admin_Board.html';
        }
    </script>
</body>
</html>
